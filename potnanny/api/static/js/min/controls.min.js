const CONTROL_DEFAULT={name:null,outlet:null,device_id:null,attributes:{input_device_id:null,type:null,on:{condition:null,threshold:null,seconds:0},off:{condition:null,threshold:null}}};var inputDevice={reports:[]};const selectChoices=[[">","greater than"],[">=","greater than, or equal to"],["<","less than"],["<=","less than, or equal to"],["==","equal to"]];var Control={list:[],current:CONTROL_DEFAULT,loadList:function(){let t=API_URI+"/controls";return fetch(t,{method:"GET",credentials:"same-origin",headers:{"X-CSRF-Token":CSRF_TOKEN,"Content-Type":"application/json"}}).then((function(t){return t.ok?t.json():{msg:[]}})).then((function(t){Control.list=t.msg})).catch((function(t){console.log(t)}))},load:function(t){Control.current=CONTROL_DEFAULT;for(let e of Control.list)if(e.id==t){Control.current=e;break}},loadDeviceOutlet:function(t,e){Control.current=CONTROL_DEFAULT;for(let o of Control.list)if(o.device_id==t&&o.outlet==e){Control.current=o;break}},save:function(){let t="POST",e=API_URI+"/controls";return Control.current.id&&(t="PATCH",e+="/"+Control.current.id),Control.current.attributes.on.seconds&&Control.current.attributes.on.seconds>0&&(Control.current.attributes.off={}),fetch(e,{method:t,credentials:"same-origin",headers:{"X-CSRF-Token":CSRF_TOKEN,"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify(Control.current)}).then((function(t){if(t.ok)return t.json()})).then((function(t){Control.current=CONTROL_DEFAULT,Control.loadList()})).catch((function(t){console.log(t)}))},delete:function(){let t=API_URI+"/controls/"+Control.current.id;return fetch(t,{method:"DELETE",credentials:"same-origin",headers:{"X-CSRF-Token":CSRF_TOKEN,"Content-Type":"application/json"}}).then((function(t){if(t.ok)return t.json();throw"response was not ok"})).then((function(t){Control.current=CONTROL_DEFAULT})).catch((function(t){console.log(t)}))}};const updateMeasurementChoices=function(){var t=document.getElementById("ctrl-input-device");if(null!=t.value){Device.list.map((function(e){e.id==parseInt(t.value)&&(inputDevice=e)}));var e=document.getElementById("ctrl-mchoices"),o=[m("option"),inputDevice.reports.map((function(t){return m("option",{value:t,selected:Control.current.attributes.type==t},t)}))];m.render(e,o)}},toggleTimedOn=function(){document.getElementById("ctrl-on-timed").checked?(document.getElementById("ctrl-seconds-block").style.display="block",document.getElementById("ctrl-off-block").style.display="none",document.getElementById("ctrl-off-condition").required=!1,document.getElementById("ctrl-off-threshold").required=!1,document.getElementById("ctrl-on-seconds").required=!0):(Control.current.attributes.on.seconds=0,document.getElementById("ctrl-seconds-block").style.display="none",document.getElementById("ctrl-off-block").style.display="block",document.getElementById("ctrl-on-seconds").required=!1,document.getElementById("ctrl-off-condition").required=!0,document.getElementById("ctrl-off-threshold").required=!0)},submitControlForm=function(){Control.save(),hideModal(),Control.current=CONTROL_DEFAULT,setTimeout((function(){window.location.reload()}),1200),Control.loadList()},controlForm=function(t,e){let o=parseInt(e.split("_")[1]);console.log("Device:"+t+" Outlet:"+o),Device.load(t),Control.loadDeviceOutlet(t,o);const n=Number(Device.current.room_id);null==Control.current.device_id&&(Control.current.device_id=t),null==Control.current.outlet&&(Control.current.outlet=o);var r=m("form",{onsubmit:function(t){t.preventDefault()}},[m("div",[m("label.form-label","Control Name"),m("input[type=text].form-control",{required:!0,value:Control.current.name,onchange:function(t){Control.current.name=t.target.value}})]),m("div.row.row-cols-2.mt-2",[m("div.col",[m("label.form-label","Input device"),m("select.form-control",{id:"ctrl-input-device",required:!0,onchange:function(t){Control.current.attributes.input_device_id=parseInt(t.target.value),Device.load(parseInt(t.target.value)),updateMeasurementChoices()}},[m("option"),Device.list.map((function(e){return e.room_id!=n||e.id==t?null:m("option",{value:e.id,selected:Control.current.attributes.input_device_id==e.id},e.name)}))])]),m("div.col",[m("label.form-label","Measurement"),m("select.form-control",{id:"ctrl-mchoices",onchange:function(t){Control.current.attributes.type=t.target.value}},[m("option"),Device.current.reports.map((function(t){return m("option",{value:t,selected:Control.current.attributes.type==t},t)}))])])]),m("div.card.mt-2",{id:"ctrl-on-block"},[m("div.card-header",["Outlet ON",m("span",{style:{float:"right"}},[m("label.form-checkbox-label.mr-2",{for:"ctrl-on-timed"},"timed ON"),m("input[type=checkbox].form-checkbox-control",{id:"ctrl-on-timed",checked:"seconds"in Control.current.attributes.on&&Control.current.attributes.on.seconds>0,onchange:function(t){document.getElementById("ctrl-on-timed").checked?(document.getElementById("ctrl-seconds-block").style.display="block",document.getElementById("ctrl-off-block").style.display="none",document.getElementById("ctrl-off-condition").required=!1,document.getElementById("ctrl-off-threshold").required=!1,document.getElementById("ctrl-on-seconds").required=!0):(Control.current.attributes.on.seconds=0,document.getElementById("ctrl-seconds-block").style.display="none",document.getElementById("ctrl-off-block").style.display="block",document.getElementById("ctrl-on-seconds").required=!1,document.getElementById("ctrl-off-condition").required=!0,document.getElementById("ctrl-off-threshold").required=!0)}})])]),m("div.card-body",[m("div.row.row-cols-2",[m("div.col",m("select.form-control.col",{required:!0,onchange:function(t){Control.current.attributes.on.condition=t.target.value}},[m("option"),selectChoices.map((function(t){return m("option",{value:t[0],selected:Control.current.attributes.on.condition==t[0]},t[1])}))])),m("div.col",m("input[type=number][step=any].form-control",{required:!0,value:Control.current.attributes.on.threshold,onchange:function(t){Control.current.attributes.on.threshold=parseFloat(t.target.value)}}))]),m("div.row.row-cols-2.mt-2",[m("div.col",{id:"ctrl-seconds-block",style:{display:"seconds"in Control.current.attributes.on&&Control.current.attributes.on.seconds>0?"block":"none"}},[m("label.form-label.mt-3","ON seconds"),m("input[type=number][step=any].form-control.col",{id:"ctrl-on-seconds",min:1,max:300,step:1,required:"seconds"in Control.current.attributes.on&&Control.current.attributes.on.seconds>0,value:Control.current.attributes.on.seconds,onchange:function(t){Control.current.attributes.on.seconds=parseFloat(t.target.value)}})])])])]),m("div.card.mt-2",{id:"ctrl-off-block",style:{display:"seconds"in Control.current.attributes.on&&Control.current.attributes.on.seconds>0?"none":"block"}},[m("div.card-header","Outlet OFF"),m("div.card-body",m("div.row.row-cols-2",[m("div.col",[m("select.form-control",{id:"ctrl-off-condition",required:!("seconds"in Control.current.attributes.on&&Control.current.attributes.on.seconds>0),onchange:function(t){Control.current.attributes.off.condition=t.target.value}},[m("option"),selectChoices.map((function(t){return m("option",{value:t[0],selected:Control.current.attributes.off.condition==t[0]},t[1])}))])]),m("div.col",m("input[type=number][step=any].form-control",{id:"ctrl-off-threshold",required:!("seconds"in Control.current.attributes.on&&Control.current.attributes.on.seconds>0),value:Control.current.attributes.off.threshold,onchange:function(t){Control.current.attributes.off.threshold=parseFloat(t.target.value)}}))]))]),m("div.row.row-cols-2.mt-3",[m("div.col",m("button[type=submit].btn.btn-primary.form-control",{onclick:function(){Control.save(),hideModal(),Control.current=CONTROL_DEFAULT,setTimeout((function(){window.location.reload()}),1200),Control.loadList()}},"Save")),Control.current.id?m("div.col",m("button.btn.btn-outline-danger.form-control",{onclick:function(t){t.preventDefault(),confirm("Are you sure you want to delete this control?")&&(Control.delete(),hideModal(),Control.current=CONTROL_DEFAULT,Control.loadList(),setTimeout((function(){window.location.reload()}),1500))}},"Delete")):null])]);showModal(r),updateMeasurementChoices()};Control.loadList();
